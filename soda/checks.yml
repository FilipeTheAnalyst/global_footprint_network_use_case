# Soda Data Quality Checks for Snowflake (Post-Load Validation)
# https://docs.soda.io/soda-cl/soda-cl-overview.html
#
# Purpose: Validate data AFTER loading to Snowflake warehouse
# Scope: Production data quality monitoring
# Usage: soda scan -d snowflake -c soda/configuration.yml soda/checks.yml
#
# Note: For staging layer checks (before loading), see soda/staging_checks.yml

# =============================================================================
# RAW TABLE CHECKS - GFN Footprint Data
# =============================================================================

checks for GFN_FOOTPRINT_DATA_RAW:
  # Row count validation - expect data for ~184 countries × 28 record types × ~60 years
  - row_count > 0:
      name: "Raw table has data"
  
  # Freshness check - data should be loaded within last 24 hours
  - freshness(_LOADED_AT) < 1d:
      name: "Data loaded within 24 hours"
  
  # Required columns are not null
  - missing_count(COUNTRY_CODE) = 0:
      name: "Country code is required"
  - missing_count(COUNTRY_NAME) = 0:
      name: "Country name is required"
  - missing_count(YEAR) = 0:
      name: "Year is required"
  - missing_count(RECORD_TYPE) = 0:
      name: "Record type is required"
  - missing_count(RECORD_CATEGORY) = 0:
      name: "Record category is required"
  
  # Data type validations
  - invalid_count(YEAR) = 0:
      name: "Year is valid"
      valid min: 1960
      valid max: 2030
  
  # Value should be non-negative (global hectares)
  - invalid_count(VALUE) = 0:
      name: "Value is non-negative"
      valid min: 0
  
  # Record type validation - must be one of the valid types from GFN API
  - invalid_count(RECORD_TYPE) = 0:
      name: "Record type is valid"
      valid values:
        # Ecological Footprint - Total (Global Hectares)
        - EFConsTotGHA
        - EFProdTotGHA
        - EFImportsTotGHA
        - EFExportsTotGHA
        # Ecological Footprint - Per Capita
        - EFConsPerCap
        - EFProdPerCap
        - EFImportsPerCap
        - EFExportsPerCap
        # Biocapacity
        - BiocapTotGHA
        - BiocapPerCap
        # Area
        - AreaTotHA
        - AreaPerCap
        # Economic & Social Indicators
        - Population
        - GDP-PPP
        - GDP-USD
        - HDI
        # Derived
        - Earths
        # Legacy record types (for backward compatibility)
        - EFCtot
        - EFCcrop
        - EFCgraz
        - EFCfrst
        - EFCfish
        - EFCbult
        - EFCcarb
        - BioCaptot
        - BioCapcrop
        - BioCapgraz
        - BioCapfrst
        - BioCapfish
        - BioCapbult
        - EFCtotPerCap
        - EFCcropPerCap
        - EFCgrazPerCap
        - EFCfrstPerCap
        - EFCfishPerCap
        - EFCbultPerCap
        - EFCcarbPerCap
        - BioCaptotPerCap
        - BioCapcropPerCap
        - BioCapgrazPerCap
        - BioCapfrstPerCap
        - BioCapfishPerCap
        - BioCapbultPerCap
  
  # Record category validation
  - invalid_count(RECORD_CATEGORY) = 0:
      name: "Record category is valid"
      valid values:
        - ecological_footprint
        - biocapacity
  
  # Uniqueness check - one record per country per year per record type
  - duplicate_count(COUNTRY_CODE, YEAR, RECORD_TYPE) = 0:
      name: "No duplicate country-year-type records"

  # Schema evolution check - ensure expected columns exist
  - schema:
      name: "Schema has required columns"
      fail:
        when required column missing:
          - COUNTRY_CODE
          - COUNTRY_NAME
          - YEAR
          - RECORD_TYPE
          - RECORD_CATEGORY
          - VALUE
          - PER_CAPITA
          - _LOADED_AT

# =============================================================================
# COVERAGE CHECKS - Ensure comprehensive data extraction
# =============================================================================

checks for GFN_FOOTPRINT_DATA_RAW:
  # Ensure we have all 28 record types
  - row_count same as GFN_FOOTPRINT_DATA_RAW:
      name: "All record types present"
      filter: RECORD_TYPE IN ('EFCtot', 'BioCaptot')
      # At minimum, we should have total footprint and biocapacity
  
  # Ensure reasonable country coverage (expect ~180+ countries)
  - distinct_count(COUNTRY_CODE) >= 150:
      name: "Sufficient country coverage"
  
  # Ensure data spans multiple decades
  - distinct_count(YEAR) >= 50:
      name: "Sufficient year coverage"

# =============================================================================
# TRANSFORMED/PROCESSED TABLE CHECKS (if applicable)
# =============================================================================

# checks for GFN_FOOTPRINT_DATA:
#   - row_count > 0:
#       name: "Processed table has data"
#   
#   - missing_count(VALUE) = 0:
#       name: "All records have values"
