# =============================================================================
# GFN Pipeline - Docker Compose
# =============================================================================
# 
# Services:
#   - localstack: AWS services simulation (S3, SQS, SNS, Lambda, EventBridge)
#   - pipeline: Main pipeline container (DuckDB/Snowflake)
#   - duckdb-ui: Optional DuckDB web interface
#
# S3 Structure (simplified):
#   s3://gfn-data-lake/
#   ├── raw/                    # Raw extracted data
#   │   └── gfn_footprint_{YYYYMMDD_HHMMSS}.json
#   └── transformed/            # Processed data ready for Snowpipe
#       └── gfn_footprint_{YYYYMMDD_HHMMSS}_transformed.json
#
# Usage:
#   make docker-up              # Start LocalStack
#   make docker-pipeline        # Run pipeline in container
#   make docker-down            # Stop all services
# =============================================================================

services:
  # ===========================================================================
  # LocalStack - AWS Services Simulation
  # ===========================================================================
  localstack:
    image: localstack/localstack:3.0
    container_name: gfn-localstack
    ports:
      - "4566:4566"           # LocalStack Gateway
      - "4510-4559:4510-4559" # External services port range
    environment:
      - DEBUG=${LOCALSTACK_DEBUG:-0}
      - SERVICES=s3,sqs,sns,events,stepfunctions,logs,cloudwatch,lambda,iam,apigateway
      - AWS_DEFAULT_REGION=us-east-1
      - LAMBDA_EXECUTOR=docker
      - DOCKER_HOST=unix:///var/run/docker.sock
      - PERSISTENCE=1
    volumes:
      - "./localstack-data:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gfn-network

  # ===========================================================================
  # GFN Pipeline Container
  # ===========================================================================
  # Main pipeline that can run with DuckDB (local) or Snowflake (production)
  # Supports both dlt+DuckDB approach and AWS Lambda approach
  pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gfn-pipeline
    environment:
      # API Configuration
      - GFN_API_KEY=${GFN_API_KEY}
      
      # Destination (duckdb, snowflake, or both)
      - PIPELINE_DESTINATION=${PIPELINE_DESTINATION:-duckdb}
      
      # DuckDB Configuration
      - DUCKDB_PATH=/data/gfn.duckdb
      
      # Snowflake Configuration (optional)
      - SNOWFLAKE_ACCOUNT=${SNOWFLAKE_ACCOUNT:-}
      - SNOWFLAKE_USER=${SNOWFLAKE_USER:-}
      - SNOWFLAKE_PASSWORD=${SNOWFLAKE_PASSWORD:-}
      - SNOWFLAKE_WAREHOUSE=${SNOWFLAKE_WAREHOUSE:-COMPUTE_WH}
      - SNOWFLAKE_DATABASE=${SNOWFLAKE_DATABASE:-GFN}
      - SNOWFLAKE_SCHEMA=${SNOWFLAKE_SCHEMA:-RAW}
      
      # LocalStack Configuration
      - AWS_ENDPOINT_URL=http://localstack:4566
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_REGION=us-east-1
      - S3_BUCKET=gfn-data-lake
      
      # Backfill Configuration (optional)
      - START_YEAR=${START_YEAR:-2020}
      - END_YEAR=${END_YEAR:-2024}
    volumes:
      - "./data:/data"
      - "./logs:/app/logs"
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - gfn-network
    profiles:
      - pipeline

  # ===========================================================================
  # Lambda Pipeline Runner (Alternative approach using Lambda handlers)
  # ===========================================================================
  lambda-pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gfn-lambda-pipeline
    entrypoint: ["python", "-m", "infrastructure.lambda_handlers"]
    command: ["extract", "--start-year", "${START_YEAR:-2020}", "--end-year", "${END_YEAR:-2024}"]
    environment:
      - GFN_API_KEY=${GFN_API_KEY}
      - AWS_ENDPOINT_URL=http://localstack:4566
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_REGION=us-east-1
      - S3_BUCKET=gfn-data-lake
      - DUCKDB_PATH=/data/gfn_lambda.duckdb
    volumes:
      - "./data:/data"
      - "./logs:/app/logs"
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - gfn-network
    profiles:
      - lambda

  # ===========================================================================
  # DuckDB Web UI (Optional)
  # ===========================================================================
  duckdb-ui:
    image: evidence/evidence:latest
    container_name: gfn-duckdb-ui
    ports:
      - "3000:3000"
    volumes:
      - "./data:/data:ro"
    environment:
      - DATABASE_URL=duckdb:///data/gfn.duckdb
    networks:
      - gfn-network
    profiles:
      - ui

networks:
  gfn-network:
    name: gfn-network
    driver: bridge

volumes: {}
